import{P as _,W as O}from"./C-YwiueS.js";import{_ as E,r as f,o as N,H as j,t as A,v as z,x,y as I,z as T}from"./DMAY1QfJ.js";class b{constructor(){this.image=null,this.collision=!1}async loadImage(e){return new Promise(s=>{this.image=new Image,this.image.onload=()=>s(),this.image.src=e})}}class K{constructor(e,s,i){this.tiles=[],this.tileMap=[],this.maxScreenCol=e,this.maxScreenRow=s,this.tileSize=i,this.tiles=new Array(20).fill(null).map(()=>new b),this.tileMap=Array(e).fill(0).map(()=>Array(s).fill(0))}async loadTiles(){const s=[{path:"/map/SeRenta.png",collision:!0},{path:"/map/grass.png",collision:!0},{path:"/map/tree.png",collision:!0},{path:"/map/Peluqueria.png",collision:!0},{path:"/map/Bar.png",collision:!0},{path:"/map/roadNEWS.png",collision:!1},{path:"/map/roadNS.png",collision:!1},{path:"/map/Farmacia.png",collision:!0},{path:"/map/Fotostudio.png",collision:!0},{path:"/map/Panaderia.png",collision:!0},{path:"/map/Fruteria.png",collision:!0},{path:"/map/Musica.png",collision:!0},{path:"/map/Cafe.png",collision:!0},{path:null,collision:!1},{path:"/map/Internet.png",collision:!0},{path:"/map/roadEW.png",collision:!1},{path:"/map/roadSW.png",collision:!1},{path:"/map/roadNE.png",collision:!1},{path:"/map/roadSE.png",collision:!1},{path:"/map/roadNW.png",collision:!1},{path:"/map/tiendasD1.png",collision:!0},{path:"/map/tiendasAra.png",collision:!0}].map((i,t)=>i.path?new Promise(a=>{this.tiles[t]=new b,this.tiles[t].collision=i.collision,this.tiles[t].image=new Image,this.tiles[t].image.onload=()=>a(),this.tiles[t].image.src=i.path}):Promise.resolve());await Promise.all(s)}async loadMap(e){const s=e.trim().split(`
`);for(let i=0;i<this.maxScreenRow;i++){const t=s[i].trim().split(" ");for(let a=0;a<this.maxScreenCol;a++)this.tileMap[a][i]=parseInt(t[a])}}draw(e){for(let s=0;s<this.maxScreenRow;s++)for(let i=0;i<this.maxScreenCol;i++){const t=i*this.tileSize,a=s*this.tileSize,l=this.tileMap[i][s];this.tiles[l]&&this.tiles[l].image&&e.drawImage(this.tiles[l].image,t,a,this.tileSize,this.tileSize)}}getTileCollision(e,s){if(e<0||e>=this.maxScreenCol||s<0||s>=this.maxScreenRow)return!0;const i=this.tileMap[e][s];return this.tiles[i]?.collision??!1}}class R{constructor(){this.name="",this.image=null,this.collision=!1,this.x=0,this.y=0,this.scale=1}draw(e,s){if(this.image){const i=s.tileSize*.7,t=(s.tileSize-i)/2,a=(s.tileSize-i)/2;e.drawImage(this.image,this.x+t,this.y+a,i,i)}}}class U extends R{constructor(e){super(),this.name="person",this.loadImage(e)}async loadImage(e){return new Promise(s=>{this.image=new Image,this.image.onload=()=>s(),this.image.src=`/person/${e}`})}}class W extends R{constructor(e){super(),this.name="obstacles",this.collision=!0,this.loadImage(e)}async loadImage(e){return new Promise(s=>{this.image=new Image,this.image.onload=()=>s(),this.image.src=`/objects/${e}`})}}class B{constructor(e){this.tileSize=e,this.objects=new Array(15).fill(null)}async setObjects(){const e=[{file:"PersonaCorbata.png",x:4,y:6},{file:"PersonaNaranja.png",x:8,y:5},{file:"mujer.png",x:10,y:3},{file:"mujer1.png",x:12,y:7},{file:"personaCampesino.png",x:5,y:5},{file:"personaEstudiante.png",x:2,y:4},{file:"personaVerde.png",x:6,y:9},{file:"tombo.png",x:3,y:4},{file:"tombo1.png",x:14,y:9}],s=[{file:"huecos.png",x:6,y:6},{file:"motoEnElPiso.png",x:3,y:3},{file:"senal.png",x:9,y:11},{file:"senal1.png",x:9,y:10},{file:"senal2.png",x:8,y:9},{file:"senal3.png",x:9,y:9}],i=[];return e.forEach((t,a)=>{this.objects[a]=new U(t.file),this.objects[a].x=t.x*this.tileSize,this.objects[a].y=t.y*this.tileSize,i.push(this.objects[a].loadImage(t.file))}),s.forEach((t,a)=>{const l=a+e.length;this.objects[l]=new W(t.file),this.objects[l].x=t.x*this.tileSize,this.objects[l].y=t.y*this.tileSize,i.push(this.objects[l].loadImage(t.file))}),await Promise.all(i),this.objects}}class H{constructor(e,s){this.tileSize=e,this.tileManager=s}checkTile(e){const s=e.x+e.solidArea.x,i=e.x+e.solidArea.x+e.solidArea.width,t=e.y+e.solidArea.y,a=e.y+e.solidArea.y+e.solidArea.height,l=Math.floor(s/this.tileSize),p=Math.floor(i/this.tileSize),c=Math.floor(t/this.tileSize),w=Math.floor(a/this.tileSize);let h,r;switch(e.direction){case"up":const m=Math.floor((t-e.speed)/this.tileSize);h=this.tileManager.tileMap[l][m],r=this.tileManager.tileMap[p][m],(this.tileManager.tiles[h]?.collision||this.tileManager.tiles[r]?.collision)&&(e.collisionOn=!0);break;case"down":const v=Math.floor((a+e.speed)/this.tileSize);h=this.tileManager.tileMap[l][v],r=this.tileManager.tileMap[p][v],(this.tileManager.tiles[h]?.collision||this.tileManager.tiles[r]?.collision)&&(e.collisionOn=!0);break;case"left":const y=Math.floor((s-e.speed)/this.tileSize);h=this.tileManager.tileMap[y][c],r=this.tileManager.tileMap[y][w],(this.tileManager.tiles[h]?.collision||this.tileManager.tiles[r]?.collision)&&(e.collisionOn=!0);break;case"right":const P=Math.floor((i+e.speed)/this.tileSize);h=this.tileManager.tileMap[P][c],r=this.tileManager.tileMap[P][w],(this.tileManager.tiles[h]?.collision||this.tileManager.tiles[r]?.collision)&&(e.collisionOn=!0);break}}checkObject(e,s,i=!1,t=null){let a=999;return s.forEach((l,p)=>{if(!l)return;const c={x:e.x+e.solidArea.x,y:e.y+e.solidArea.y,width:e.solidArea.width,height:e.solidArea.height},w={x:l.x+(l.solidArea?.x||0),y:l.y+(l.solidArea?.y||0),width:l.solidArea?.width||this.tileSize,height:l.solidArea?.height||this.tileSize};switch(e.direction){case"up":c.y-=e.speed;break;case"down":c.y+=e.speed;break;case"left":c.x-=e.speed;break;case"right":c.x+=e.speed;break}this.checkIntersect(c,w)&&(l.collision&&(e.collisionOn=!0),i&&(a=p),i&&t&&t.isConnected&&(e.hasPerson=!e.hasPerson,t.sendHasPersonUpdate(e.hasPerson)))}),a}checkIntersect(e,s){return e.x<s.x+s.width&&e.x+e.width>s.x&&e.y<s.y+s.height&&e.y+e.height>s.y}}class F{constructor(){this.upPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.rightPressed=!1,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this)}init(){typeof window<"u"&&(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp))}handleKeyDown(e){switch(e.key.toLowerCase()){case"w":this.upPressed=!0;break;case"s":this.downPressed=!0;break;case"a":this.leftPressed=!0;break;case"d":this.rightPressed=!0;break}}handleKeyUp(e){switch(e.key.toLowerCase()){case"w":this.upPressed=!1;break;case"s":this.downPressed=!1;break;case"a":this.leftPressed=!1;break;case"d":this.rightPressed=!1;break}}cleanup(){typeof window<"u"&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp))}}const G={class:"game-container"},$={class:"game-hud"},V={class:"score"},X={class:"players-online"},q=26,Z=3,k=16,C=12,J={__name:"GameCanvas",setup(g){const e=q*Z,s=e*k,i=e*C,t=f(new F),a=f(null),l=f(null),p=f(null),c=f(new _(s,i,e)),w=f(new Array(15).fill(null)),h=f(null),r=f(new O),m=f(new Map),v=async()=>{p.value=new K(k,C,e),h.value=new H(e,p.value);const d=new B(e);await Promise.all([p.value.loadTiles(),c.value.loadImages(),d.setObjects().then(o=>{w.value=o})]),await p.value.loadMap(`
    15 16 1 6 3 1 6 2 1 6 1 8 6 2 18 15
    1 6 2 6 21 14 6 1 4 6 20 1 6 1 6 2
    1 17 15 5 15 15 5 15 15 5 15 15 5 15 19 1
    2 9 0 6 1 7 6 1 3 6 1 8 6 4 1 0
    20 1 1 6 10 1 6 1 2 6 21 1 6 1 11 2
    15 15 15 5 15 15 5 15 15 5 15 15 5 15 15 15
    1 2 1 6 4 2 6 1 12 6 1 3 6 2 10 1
    3 1 11 6 1 14 6 1 1 6 7 1 6 1 2 1
    1 1 2 6 2 1 6 0 1 6 1 1 6 20 1 1
    1 18 15 5 15 15 5 15 15 5 15 15 5 15 16 9
    9 6 2 6 1 1 6 10 20 6 14 2 6 14 6 1
    15 19 1 6 12 2 6 1 1 6 1 1 6 1 17 15

`),r.value.onPlayersUpdate=async o=>{const u=r.value.getLocalPlayerId();if(!m.value.has(o.id)&&o.id!==u){const n=new _(s,i,e,o.id);await n.loadImages(),m.value.set(o.id,n)}if(o.id!==u){const n=m.value.get(o.id);if(n){const L="hasPerson"in o&&n.hasPerson!==o.hasPerson;n.x=o.x??n.x,n.y=o.y??n.y,n.direction=o.direction??n.direction,L&&(n.hasPerson=o.hasPerson,n.getCurrentImage(),console.log("ðŸŽ® Player Update:",{id:o.id,hasPerson:o.hasPerson,timestamp:new Date().toISOString()}))}}},r.value.onPlayerDisconnect=o=>{m.value.delete(o)},r.value.onConnect=o=>{playerId.value=o,c.value.id=o}},y=()=>{const d=a.value.getContext("2d");d.clearRect(0,0,s,i),d.fillStyle="black",d.fillRect(0,0,s,i),p.value&&p.value.draw(d),console.log();const S=r.value.getLocalPlayerId(),o=[...m.value.values()].filter(u=>u.id!==S);o.sort((u,n)=>u.y-n.y);for(let u=0;u<i;u++)w.value.forEach(n=>{n&&n.y===u&&n.draw(d,{tileSize:e})}),o.forEach(n=>{Math.floor(n.y)===u&&n.draw(d)});c.value.draw(d)},P=()=>{if(c.value&&h.value){const d={up:t.value.upPressed,down:t.value.downPressed,left:t.value.leftPressed,right:t.value.rightPressed};c.value.update(d,h.value,w.value,r.value)&&r.value.sendPlayerPosition({id:r.value.getLocalPlayerId(),x:c.value.x,y:c.value.y,direction:c.value.direction})}},M=()=>{P(),y(),l.value=requestAnimationFrame(M)};return N(async()=>{await v(),t.value.init(),r.value.connect(),M()}),j(()=>{t.value.cleanup(),r.value.disconnect(),l.value&&cancelAnimationFrame(l.value)}),(d,S)=>(z(),A("div",G,[x("canvas",{ref_key:"gameCanvas",ref:a,width:s,height:i},null,512),x("div",$,[x("span",V,"Personas: "+I(c.value.hasPerson),1),x("span",X,"Jugadores Online: "+I(m.value.size+1),1)])]))}},Y=E(J,[["__scopeId","data-v-5a03252e"]]),Q={class:"game-page"},D={__name:"page",setup(g){return(e,s)=>(z(),A("div",Q,[T(Y)]))}},ie=E(D,[["__scopeId","data-v-2610d004"]]);export{ie as default};
